<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Komnottra</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    /* Minimal inline styles for demo */
    .hidden { display: none; }
    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" data-animated="logo.gif" data-static="logo.png" alt="Komnottra Logo" class="logo" />
    <div id="menuToggle" class="menu-toggle">&#9776;</div>
  </header>

  <div id="overlay" class="overlay"></div>

  <nav id="sideMenu" class="side-menu">
    <button id="viewTab" class="active">Home</button>
    <button id="writeTab">Admin Write</button>
  </nav>

  <!-- Categories Row -->
  <div id="categoryNav" class="category-nav"></div>

  <div class="container">
    <!-- Article List / Home Section -->
    <section id="viewSection" class="section active">
      <div id="articlesList"></div>
    </section>

    <!-- Article Detail Section -->
    <section id="articleDetailSection" class="section hidden">
      <a class="back-link" id="backToList">&larr; ត្រលប់ទៅ ផ្ទាំងព័ត៌មានចម្រុះ</a>
      <div id="articleContainer" class="article-full">
        <p>កំពុងទាញយកព័ត៌មាន...</p>
      </div>
    </section>

    <!-- Admin Write Section -->
    <section id="writeSection" class="section hidden">
      <h2>Write New Article</h2>
      <form id="articleForm">
        <select id="categorySelect">
          <option value="" disabled selected>Select Category (Optional)</option>
        </select>
        <input type="text" id="title" placeholder="Article Title" required />
        <textarea id="content" rows="8" placeholder="Article Content" required></textarea>
        <input type="file" id="imageUpload" accept="image/*" />
        <button type="submit">Publish</button>
      </form>

      <div id="categoryPanel" class="admin-panel">
        <h3>Category Management</h3>
        <div class="category-form">
          <input type="text" id="newCategory" placeholder="New Category Name" />
          <button type="button" id="createCategoryBtn">Create Category</button>
        </div>

        <div class="category-delete">
          <select id="deleteCategorySelect">
            <option disabled selected>Select Category to Delete</option>
          </select>
          <button type="button" id="deleteCategoryBtn">Delete Category</button>
        </div>
      </div>

      <div id="adminArticles"></div>
    </section>
  </div>

  <footer style="text-align:center; padding:1rem; background:#f5f5f5;">
    <p>&copy; 2025 Komnottra</p>
  </footer>

  <script>
    const API_BASE = "https://komnottra-backend.onrender.com";

    // Menu toggle
    const menuToggle = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");

    menuToggle.addEventListener("click", () => {
      sideMenu.classList.toggle("open");
      overlay.classList.toggle("active");
    });

    overlay.addEventListener("click", () => {
      sideMenu.classList.remove("open");
      overlay.classList.remove("active");
    });

    // Logo hover animation
    const logo = document.querySelector(".logo");
    if (logo && logo.dataset.animated && logo.dataset.static) {
      logo.addEventListener("mouseover", () => {
        logo.src = logo.dataset.animated;
      });
      logo.addEventListener("mouseout", () => {
        logo.src = logo.dataset.static;
      });
    }

    // Tabs
    const viewTab = document.getElementById("viewTab");
    const writeTab = document.getElementById("writeTab");
    const viewSection = document.getElementById("viewSection");
    const writeSection = document.getElementById("writeSection");
    const articleDetailSection = document.getElementById("articleDetailSection");

    viewTab.addEventListener("click", () => {
      showSection("view");
    });

    writeTab.addEventListener("click", () => {
      showSection("write");
    });

    function showSection(section) {
      // Remove active class from buttons
      viewTab.classList.remove("active");
      writeTab.classList.remove("active");

      // Hide all sections
      viewSection.classList.add("hidden");
      writeSection.classList.add("hidden");
      articleDetailSection.classList.add("hidden");

      if (section === "view") {
        viewTab.classList.add("active");
        viewSection.classList.remove("hidden");
      } else if (section === "write") {
        writeTab.classList.add("active");
        writeSection.classList.remove("hidden");
      } else if (section === "articleDetail") {
        articleDetailSection.classList.remove("hidden");
      }

      // Close menu and overlay on tab click
      sideMenu.classList.remove("open");
      overlay.classList.remove("active");
    }

    // Categories UI
    const categoryNav = document.getElementById("categoryNav");
    const categorySelect = document.getElementById("categorySelect");
    const deleteCategorySelect = document.getElementById("deleteCategorySelect");

    async function fetchCategories() {
      try {
        const res = await fetch(`${API_BASE}/categories`);
        if (!res.ok) throw new Error("Failed to fetch categories");
        const categories = await res.json();
        populateCategories(categories);
      } catch (err) {
        console.error(err);
      }
    }

    function populateCategories(categories) {
      categoryNav.innerHTML = '<button data-category="">All</button>' + categories.map(cat => `<button data-category="${cat}">${cat}</button>`).join("");
      categorySelect.innerHTML = '<option value="" disabled selected>Select Category (Optional)</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join("");
      deleteCategorySelect.innerHTML = '<option disabled selected>Select Category to Delete</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join("");

      // Add click event for category buttons in nav
      [...categoryNav.querySelectorAll("button")].forEach(btn => {
        btn.addEventListener("click", () => {
          loadArticles(btn.dataset.category);
          // Highlight selected category
          [...categoryNav.querySelectorAll("button")].forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });
    }

    // Articles list and filtering
    const articlesList = document.getElementById("articlesList");

    async function fetchArticles(category = "") {
      let url = `${API_BASE}/articles`;
      if (category) url += `?category=${encodeURIComponent(category)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch articles");
        const articles = await res.json();
        return articles;
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    async function loadArticles(category = "") {
      articlesList.innerHTML = "<p>កំពុងទាញយកព័ត៌មាន...</p>";
      const articles = await fetchArticles(category);
      if (articles.length === 0) {
        articlesList.innerHTML = "<p>មិនមានព័ត៌មានសម្រាប់ប្រភេទនេះទេ។</p>";
        return;
      }
      articlesList.innerHTML = articles
        .map(
          (a) => `
        <article class="article-preview" data-id="${a.id}">
          <h2>${a.title}</h2>
          ${a.category ? `<div class="category">ប្រភេទ៖ ${a.category}</div>` : ""}
          <div class="date">បានផ្សព្វផ្សាយ: ${formatDate(a.createdAt)}</div>
          ${a.image ? `<img src="${a.image}" alt="Article Image" />` : ""}
          <p>${a.content.substring(0, 150)}...</p>
        </article>
      `
        )
        .join("");

      // Add click event to open article detail
      [...articlesList.querySelectorAll("article.article-preview")].forEach((el) => {
        el.addEventListener("click", () => {
          showArticleDetail(el.dataset.id);
        });
      });
    }

    // Article Detail view
    const articleContainer = document.getElementById("articleContainer");
    const backToListBtn = document.getElementById("backToList");

    backToListBtn.addEventListener("click", () => {
      showSection("view");
    });

    async function fetchArticleById(id) {
      try {
        const res = await fetch(`${API_BASE}/articles/${id}`);
        if (!res.ok) throw new Error("Article not found");
        return await res.json();
      } catch (err) {
        return null;
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const options = { hour: "numeric", minute: "numeric", hour12: true };
      const datePart = `${String(date.getDate()).padStart(2, "0")}/${String(date.getMonth() + 1).padStart(2, "0")}/${date.getFullYear()}`;
      const timePart = date.toLocaleTimeString([], options);
      return `${datePart} ${timePart}`;
    }

    async function showArticleDetail(id) {
      showSection("articleDetail");
      articleContainer.innerHTML = "<p>កំពុងទាញយកព័ត៌មាន...</p>";
      const article = await fetchArticleById(id);
      if (!article) {
        articleContainer.innerHTML = "<p>ព័ត៌មានដែលអ្នកស្វែងរកមិនមានទេ ឬបានលុបចោល។</p>";
        return;
      }
      articleContainer.innerHTML = `
        <h1>${article.title}</h1>
        ${article.category ? `<div class="category">ប្រភេទ៖ ${article.category}</div>` : ""}
        <div class="date">បានផ្សព្វផ្សាយ: ${formatDate(article.createdAt)}</div>
        ${article.image ? `<img src="${article.image}" alt="Article Image" />` : ""}
        <div class="content">${article.content}</div>
      `;
    }

    // Initialization
    fetchCategories().then(() => loadArticles());

    // You can add admin form submission and category management JS here,
    // reusing your existing handlers from your script.js.

  </script>
</body>
</html>
