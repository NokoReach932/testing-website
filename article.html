<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Article View</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 1rem auto;
      padding: 0 1rem;
      line-height: 1.5;
    }
    .content img {
      max-width: 100%;
      height: auto;
      margin: 1rem 0;
    }
    #relatedArticlesSection {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #ccc;
    }
    #relatedArticlesList .article-preview {
      cursor: pointer;
      margin-bottom: 1rem;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    #relatedArticlesList .article-preview:hover {
      background-color: #f0f0f0;
    }
    #relatedArticlesList .article-preview img {
      max-width: 100px;
      max-height: 60px;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    #relatedArticlesList .article-title {
      display: inline-block;
      vertical-align: middle;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <a href="index.html">← Back to articles</a>

  <h1 id="articleTitle">Loading...</h1>
  <div class="content" id="articleContent"></div>

  <!-- Related Articles Section: below article content -->
  <div id="relatedArticlesSection" style="display:none;">
    <h3>Related Articles</h3>
    <div id="relatedArticlesList"></div>
  </div>

  <script>
    const API_BASE = "https://komnottra-backend.onrender.com";

    async function fetchArticleBySlug(slug) {
      try {
        const res = await fetch(`${API_BASE}/articles?slug=${encodeURIComponent(slug)}`);
        const articles = await res.json();
        return articles.length > 0 ? articles[0] : null;
      } catch (err) {
        console.error("Error fetching article:", err);
        return null;
      }
    }

    async function fetchArticles() {
      try {
        const res = await fetch(`${API_BASE}/articles`);
        return await res.json();
      } catch (err) {
        console.error("Failed to fetch articles", err);
        return [];
      }
    }

    function getSlugFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("slug");
    }

    function renderArticle(article) {
      document.getElementById("articleTitle").textContent = article.title;
      document.getElementById("articleContent").innerHTML = article.content;
    }

    function renderRelatedArticles(articles, currentArticleId) {
      const relatedSection = document.getElementById("relatedArticlesSection");
      const relatedList = document.getElementById("relatedArticlesList");
      relatedList.innerHTML = "";

      if (articles.length === 0) {
        relatedList.innerHTML = "<p>No related articles found.</p>";
        relatedSection.style.display = "block";
        return;
      }

      articles.forEach(article => {
        if(article.id === currentArticleId) return; // skip current article

        const div = document.createElement("div");
        div.className = "article-preview";

        // Show image if available
        let imgHTML = "";
        if(article.imageUrl) {
          const fullImageUrl = article.imageUrl.startsWith("http")
            ? article.imageUrl
            : API_BASE + article.imageUrl;
          imgHTML = `<img src="${fullImageUrl}" alt="Related article image" />`;
        }

        div.innerHTML = `${imgHTML}<span class="article-title">${article.title}</span>`;
        div.onclick = () => {
          window.location.href = `article.html?slug=${article.slug}`;
        };

        relatedList.appendChild(div);
      });

      relatedSection.style.display = "block";
    }

    window.onload = async () => {
      const slug = getSlugFromQuery();
      if (!slug) {
        document.getElementById("articleTitle").textContent = "Article not found.";
        return;
      }

      const article = await fetchArticleBySlug(slug);
      if (!article) {
        document.getElementById("articleTitle").textContent = "Article not found.";
        return;
      }

      renderArticle(article);

      // Fetch all articles and filter related by category (exact match)
      const allArticles = await fetchArticles();

      let relatedArticles = [];
      if (article.category) {
        // Category might be a string or array — normalize to array
        const currentCategories = Array.isArray(article.category)
          ? article.category
          : [article.category];

        relatedArticles = allArticles.filter(a => {
          if (a.id === article.id) return false; // exclude current
          if (!a.category) return false;

          const otherCategories = Array.isArray(a.category)
            ? a.category
            : [a.category];

          // Check if categories intersect
          return currentCategories.some(cat => otherCategories.includes(cat));
        });
      }

      renderRelatedArticles(relatedArticles, article.id);
    };
  </script>
</body>
</html>
